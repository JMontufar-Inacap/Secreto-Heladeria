{% extends "heladeria/base_generic.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'ventas/css/lista_ventas.css' %}">
{% endblock %}
{% block page_title %}Pedidos{% endblock %}

{% block content %}
<div class="sales-container">

    <div class="sales-header">
        <div class="sales-tabs">
            <button 
                class="tab-item {% if not estado %}active{% endif %}"
                onclick="cambiarEstadoTab('')"
            >
                <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
                Todos
                <span class="tab-count">{{ total_ventas|default:0 }}</span>
            </button>


            <button 
                class="tab-item {% if estado == 'COMPLETED' %}active{% endif %}"
                data-estado="COMPLETED"
                onclick="cambiarEstadoTab('COMPLETED')"
            >
                <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Completadas
                <span class="tab-count">{{ ventas_completadas|default:0 }}</span>
            </button>


            <button 
    class="tab-item {% if estado == 'PENDING' %}active{% endif %}"
    data-estado="PENDING"
    onclick="cambiarEstadoTab('PENDING')"
>
    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    Pendientes
    <span class="tab-count">{{ ventas_pendientes|default:0 }}</span>
</button>


            <button 
    class="tab-item {% if estado == 'CANCELLED' %}active{% endif %}"
    data-estado="CANCELLED"
    onclick="cambiarEstadoTab('CANCELLED')"
>
    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    Canceladas
    <span class="tab-count">{{ ventas_canceladas|default:0 }}</span>
</button>

        </div>
    </div>

    <div class="controls-row">
        <div class="search-filter-section">
            <form method="get" id="searchForm" class="search-box">
                <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input id="searchInput" type="text" name="q" class="search-input"
                    placeholder="Buscar por cliente o RUT..."
                    value="{{ query|default:'' }}">

                <input type="hidden" name="estado" value="{{ estado }}">
                <input type="hidden" name="sort" value="{{ sort }}">
                <input type="hidden" name="direction" value="{{ direction }}">
            </form>

            <select form="searchForm" id="perPageSelect" class="filter-select auto-submit">
                <option value="5"  {% if per_page == 5 %}selected{% endif %}>5 por página</option>
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10 por página</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25 por página</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50 por página</option>
            </select>

        </div>

        <div class="action-buttons">
            {% load permisos_extras %}

            {% if request.user|tiene_grupo:"Admin" or request.user|tiene_grupo:"Editor" %}
                <button class="btn-action btn-primary-action" onclick="cambiarEstadoSeleccionadas()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Cambiar Estado
                </button>
            {% endif %}

            {% if request.user|tiene_grupo:"Admin" %}
                <button class="btn-action btn-secondary-action" onclick="window.location='{% url 'exportar_ventas_excel' %}'">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Exportar Excel
                </button>
            {% endif %}

            {% if request.user|tiene_grupo:"Admin" %}
                <button class="btn-action btn-danger-action" onclick="eliminarSeleccionadas()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Eliminar
                </button>
            {% endif %}
        </div>

    </div>

    <div id="ventasTableContainer">
        {% include "ventas/_tabla_ventas.html" %}
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function toggleAll(src){
    document.querySelectorAll('.venta-checkbox').forEach(cb => {
        if(cb.closest('tr').style.display !== 'none') cb.checked = src.checked;
    });
}

function getSeleccionadas(){
    return Array.from(document.querySelectorAll('.venta-checkbox:checked')).map(cb => cb.value);
}

function eliminarSeleccionadas(){
    const ids = getSeleccionadas();
    if (!ids.length) return Swal.fire('Nada seleccionado','Selecciona al menos una venta.','info');

    Swal.fire({
        title: '¿Eliminar ventas seleccionadas?',
        text: `Se eliminarán ${ids.length} venta(s).`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        confirmButtonColor: '#ef4444'
    }).then(res => {
        if (!res.isConfirmed) return;
        fetch("{% url 'eliminar_multiples' %}", {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
            body: JSON.stringify({ids: ids})
        }).then(r=>r.json()).then(data=>{
            if(data.success){
                Swal.fire('Eliminadas','Las ventas seleccionadas fueron eliminadas.','success').then(()=> loadVentas());
            } else Swal.fire('Error','No se pudieron eliminar.','error');
        }).catch(()=>Swal.fire('Error','Problema de conexión.','error'));
    });
}

function cambiarEstadoSeleccionadas(){
    const ids = getSeleccionadas();
    if (!ids.length) return Swal.fire('Nada seleccionado','Selecciona al menos una venta.','info');

    Swal.fire({
        title:'Selecciona nuevo estado',
        input:'select',
        inputOptions: { 'PENDING':'Pendiente','COMPLETED':'Completada','CANCELLED':'Cancelada' },
        showCancelButton:true
    }).then(choice=>{
        if (!choice.isConfirmed || !choice.value) return;
        fetch("{% url 'cambiar_estado_multiples' %}", {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
            body: JSON.stringify({ids: ids, nuevo_estado: choice.value})
        }).then(r=>r.json()).then(data=>{
            if(data.success){ Swal.fire('Actualizadas','Estados modificados.','success').then(()=> loadVentas()); }
            else Swal.fire('Error','No se pudo cambiar.','error');
        }).catch(()=>Swal.fire('Error','Problema de conexión.','error'));
    });
}

function loadVentas(params={}){
    const query = document.querySelector('#searchForm input[name="q"]').value || '';
    const estado = document.querySelector('input[name="estado"]').value || '';
    const per_page = document.querySelector('#perPageSelect').value || 10;
    const page = params.page || 1;
    
    const url = new URL("{% url 'lista_ventas_ajax' %}", window.location.origin);
    url.searchParams.set('q', query);
    url.searchParams.set('estado', estado);
    url.searchParams.set('per_page', per_page);
    url.searchParams.set('page', page);

    fetch(url)
        .then(r=>r.json())
        .then(data => {
            document.querySelector('#ventasTableContainer').innerHTML = data.html;
            attachPaginationEvents();
        });
}

document.addEventListener('click', function(e){
    if(e.target.closest('.pagination-btn') && e.target.closest('.pagination-btn').dataset.page){
        const page = e.target.closest('.pagination-btn').dataset.page;
        loadVentas({page: page});
    }
});

document.getElementById('searchInput').addEventListener('keyup', function(e) {
    loadVentas();
});

document.getElementById('searchInput').addEventListener('keyup', function(e) {
    const q = this.value;

    document.querySelectorAll('form input[name="q"]').forEach(input => {
        input.value = q;
    });

    loadVentas();
});

function cambiarEstadoTab(nuevoEstado) {
    document.querySelector('input[name="estado"]').value = nuevoEstado;

    document.querySelectorAll('.tab-item').forEach(btn => btn.classList.remove('active'));

    event.target.closest('.tab-item').classList.add('active');

    loadVentas();
}



function setEstadoTab(estado) {
    document.querySelector('input[name="estado"]').value = estado;
    loadVentas();
}

document.addEventListener("change", function (e) {
    if (e.target && e.target.classList.contains("auto-submit")) {
        loadVentas();   // AJAX
    }
});


function attachPaginationEvents() {
    document.querySelectorAll(".pagination-btn").forEach(btn => {
        if (btn.dataset.page) {
            btn.addEventListener("click", function (e) {
                e.preventDefault();
                loadVentas({ page: this.dataset.page });
            });
        }
    });
}
</script>

{% endblock %}
