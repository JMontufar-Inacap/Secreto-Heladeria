{% extends 'heladeria/base_generic.html' %}
{% load static %}
{% load formatos %}
{% block page_title %}Point of Sale{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'heladeria/css/pos_home.css' %}">
{% endblock %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .dashboard-row {
      margin-left: 0 !important;
      margin-right: 0 !important;
      width: 100% !important;
  }

  .dashboard-wrapper {
      max-width: 1200px;
      margin: auto;
      padding-left: 15px;
      padding-right: 15px;
      padding-top: 20px;
      width: 100%;
  }
</style>

<div class="dashboard-wrapper">

  <div class="row h-100 gx-4 dashboard-row">
    <div class="col-md-8 col-lg-9 overflow-auto">
      <form method="get" class="mb-3 row g-2 align-items-center">
        <div class="col-sm-6 col-md-6 col-lg-6">
          <input type="text" name="q" class="form-control" placeholder="Buscar producto..." value="{{ query }}">
        </div>

        <div class="col-auto d-flex align-items-center">
          <label for="per_page" class="me-2 fw-semibold mb-0">Mostrar:</label>
          <select name="per_page" id="per_page" class="form-select me-2" style="width:auto;">
            <option value="8" {% if per_page|stringformat:'s' == '8' %}selected{% endif %}>8</option>
            <option value="12" {% if per_page|stringformat:'s' == '12' %}selected{% endif %}>12</option>
            <option value="16" {% if per_page|stringformat:'s' == '16' %}selected{% endif %}>16</option>
          </select>
          <span class="me-2">por pÃ¡gina</span>
        </div>

        <div class="col-auto ms-auto">
          <button type="submit" class="btn btn-outline-primary">Buscar</button>
        </div>
      </form>

      <div id="productos-container">
        {% include "heladeria/_pos_parcial.html" %}
      </div>
    </div>

    <!-- CARRITO -->
    <div class="col-md-4 col-lg-3 bg-light border-start d-flex flex-column">

      <div class="p-3 border-bottom">
        <h5 class="fw-bold">ðŸ›’ Carrito</h5>
      </div>

      <div id="carrito-lista" class="flex-grow-1 overflow-auto p-3">
        <p class="text-muted">No hay productos agregados</p>
      </div>

      <div class="p-3 border-top">
        <h6 class="fw-bold">Total: $<span id="total">0.00</span></h6>

        <form id="checkout-form" method="post" action="{% url 'confirmar_venta' %}">
          {% csrf_token %}
          <input type="hidden" name="carrito_json" id="carrito_json">

          <div class="mb-2">
            <label for="cliente" class="form-label fw-semibold">Cliente</label>

            <input type="text" id="cliente-search" class="form-control mb-2" placeholder="Buscar cliente...">

            <select name="cliente" id="cliente" class="form-select" required>
              <option value="" selected disabled>Selecciona un cliente</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre_completo }}</option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn btn-primary w-100 mt-2" id="finalizar-btn" disabled>
            Finalizar Compra
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const CART_KEY = 'heladeria_carrito_v1';

  function loadCartFromStorage() {
    try {
      const raw = localStorage.getItem(CART_KEY);
      if (!raw) return {};
      return JSON.parse(raw);
    } catch (e) {
      console.error('Error parseando carrito en localStorage', e);
      return {};
    }
  }

  function saveCartToStorage(cart) {
    try {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    } catch (e) {
      console.error('Error guardando carrito en localStorage', e);
    }
  }

  const carrito = loadCartFromStorage();

  function parseNumber(v) {
    if (!v) return 0;

    v = String(v).replace(/\./g, '');

    v = v.replace(',', '.');

    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
}

  
  function actualizarTotalYBoton() {
    let total = 0;
    for (const id in carrito) {
      total += carrito[id].precio * carrito[id].cantidad;
    }
    document.getElementById('total').textContent = total.toFixed(0);
    document.getElementById('finalizar-btn').disabled = Object.keys(carrito).length === 0;
    document.getElementById('carrito_json').value = JSON.stringify(carrito);
    saveCartToStorage(carrito);
  }

  function renderCarrito() {
    const lista = document.getElementById('carrito-lista');
    lista.innerHTML = '';
    if (Object.keys(carrito).length === 0) {
      lista.innerHTML = '<p class="text-muted">No hay productos agregados</p>';
      actualizarTotalYBoton();
      return;
    }

    for (const id in carrito) {
      const item = carrito[id];
      const subtotal = (item.precio * item.cantidad).toFixed(2);
      const row = document.createElement('div');
      row.className = 'd-flex justify-content-between align-items-center border-bottom py-2';
      const precio = Number(item.precio) || 0;
      const cantidad = Number(item.cantidad) || 0;
      const subtotalNum = Number(subtotal) || 0;
      row.innerHTML = `
        <div style="display: table; width: 100%;">
          <!-- Columna izquierda -->
          <div style="display: table-cell; width: 65%; vertical-align: top;">
            <strong title="${item.nombre}" style="display: block; white-space: normal;">${item.nombre}</strong>
            <small>${cantidad} Ã— $${Math.round(precio)}</small>
          </div>

          <!-- Columna derecha -->
          <div style="display: table-cell; width: 35%; vertical-align: top; text-align: right;">
            <div class="fw-bold">$${Math.round(subtotalNum)}</div>
            <div style="margin-top: 4px;">
              <button class="btn btn-sm btn-outline-secondary p-1 btn-decrease" data-id="${id}">âˆ’</button>
              <button class="btn btn-sm btn-outline-secondary p-1 btn-increase" data-id="${id}">+</button>
            </div>
            <div style="margin-top: 4px;">
              <button class="btn btn-sm btn-link text-danger p-0 mt-1 btn-remove" data-id="${id}">Eliminar</button>
            </div>
          </div>
        </div>
      `;

      lista.appendChild(row);
    }

    lista.querySelectorAll('.btn-remove').forEach(b => b.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      delete carrito[id];
      renderCarrito();
      actualizarTotalYBoton();
    }));
    lista.querySelectorAll('.btn-decrease').forEach(b => b.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      if (carrito[id]) {
        carrito[id].cantidad = Math.max(1, carrito[id].cantidad - 1);
        renderCarrito();
        actualizarTotalYBoton();
      }
    }));
    lista.querySelectorAll('.btn-increase').forEach(b => b.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      if (carrito[id]) {
        carrito[id].cantidad = Math.min(100, carrito[id].cantidad + 1);
        renderCarrito();
        actualizarTotalYBoton();
      }
    }));

    actualizarTotalYBoton();
  }

  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const name = btn.dataset.name || 'Producto';
      const price = parseNumber(btn.dataset.price);
      const input = document.getElementById(`cantidad-${id}`);
      let cantidad = 1;
      if (input) {
        cantidad = parseInt(input.value) || 1;
        if (cantidad < 1) cantidad = 1;
      }
      if (carrito[id]) {
        carrito[id].cantidad = Math.min(100, carrito[id].cantidad + cantidad);
      } else {
        carrito[id] = { nombre: name, precio: price, cantidad: Math.min(100, cantidad) };
      }

      renderCarrito();
      actualizarTotalYBoton();
    });
  });

  document.querySelectorAll('.btn-incr, .btn-decr').forEach(b => {
    b.addEventListener('click', (e) => {
      const selector = e.currentTarget.dataset.target;
      const input = document.querySelector(selector);
      if (!input) return;
      let val = parseInt(input.value) || 1;
      if (e.currentTarget.classList.contains('btn-incr')) {
        val = Math.min(100, val + 1);
      } else {
        val = Math.max(1, val - 1);
      }
      input.value = val;

    });
  });

  document.querySelectorAll('.cantidad-input').forEach(inp => {
    inp.addEventListener('focus', function () {
      if (this.value === '1') this.value = '';
    });

    inp.addEventListener('input', function () {
      this.value = this.value.replace(/[^0-9]/g, '');

      if (this.value === '') this.value = '1';
    });
  });


  renderCarrito();

  const form = document.getElementById("checkout-form");

  if (form) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);

      try {
        const response = await fetch(form.action, {
          method: "POST",
          headers: { "X-Requested-With": "XMLHttpRequest" },
          body: formData
        });

        if (!response.ok) throw new Error("Error al confirmar la compra");

        Swal.fire({
          icon: "success",
          title: "Â¡Compra confirmada!",
          text: "Tu compra ha sido registrada correctamente.",
          confirmButtonText: "Aceptar",
          timer: 2000,
          showConfirmButton: false
        });

        for (const id in carrito) delete carrito[id];
        renderCarrito();
        actualizarTotalYBoton();
        localStorage.removeItem(CART_KEY);

      } catch (error) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "No se pudo confirmar la compra. IntÃ©ntalo nuevamente.",
        });
      }
    });
  }

  const clienteSearch = document.getElementById("cliente-search");
  const clienteSelect = document.getElementById("cliente");

  if (clienteSearch && clienteSelect) {
    clienteSearch.addEventListener("input", function () {
      const filtro = this.value.toLowerCase();

      for (const option of clienteSelect.options) {
        const texto = option.textContent.toLowerCase();

        if (option.value === "") {
          option.hidden = false;
          continue;
        }

        option.hidden = !texto.includes(filtro);
      }
    });
  }

/* Ajax */
async function cargarProductos(params = {}) {
    const url = new URL("/heladeria/pos/ajax/", window.location.origin);  // Ajusta la URL a tu vista
    Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));

    const response = await fetch(url);
    if (!response.ok) return;

    const html = await response.text();
    const contenedor = document.getElementById("productos-container");
    contenedor.innerHTML = html;

    // Volver a inicializar botones de carrito en el nuevo HTML
    inicializarBotonesProductos();
}

// Captura bÃºsqueda
const busquedaInput = document.querySelector('input[name="q"]');
busquedaInput?.addEventListener("input", () => {
    cargarProductos({
        q: busquedaInput.value,
        per_page: document.getElementById("per_page").value,
        page: 1
    });
});

// Captura cambio de per_page
const perPageSelect = document.getElementById("per_page");
perPageSelect?.addEventListener("change", () => {
    cargarProductos({
        q: busquedaInput.value,
        per_page: perPageSelect.value,
        page: 1
    });
});

// Captura paginaciÃ³n (delegaciÃ³n de eventos)
document.getElementById("productos-container").addEventListener("click", (e) => {
    const btn = e.target.closest("button.pagination-btn[data-page]");
    if (!btn) return;
    const page = btn.dataset.page;
    cargarProductos({
        q: busquedaInput.value,
        per_page: perPageSelect.value,
        page: page
    });
});


// FunciÃ³n para volver a enlazar botones de carrito
function inicializarBotonesProductos() {
    // Botones Agregar
    document.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const name = btn.dataset.name || 'Producto';
            const price = parseNumber(btn.dataset.price);
            const input = document.getElementById(`cantidad-${id}`);
            let cantidad = 1;
            if (input) {
                cantidad = parseInt(input.value) || 1;
                if (cantidad < 1) cantidad = 1;
            }
            if (carrito[id]) {
                carrito[id].cantidad = Math.min(100, carrito[id].cantidad + cantidad);
            } else {
                carrito[id] = { nombre: name, precio: price, cantidad: Math.min(100, cantidad) };
            }
            renderCarrito();
            actualizarTotalYBoton();
        });
    });

    // Botones +/-
    document.querySelectorAll('.btn-incr, .btn-decr').forEach(b => {
        b.addEventListener('click', (e) => {
            const selector = e.currentTarget.dataset.target;
            const input = document.querySelector(selector);
            if (!input) return;
            let val = parseInt(input.value) || 1;
            if (e.currentTarget.classList.contains('btn-incr')) {
                val = Math.min(100, val + 1);
            } else {
                val = Math.max(1, val - 1);
            }
            input.value = val;
        });
    });

    // Inputs de cantidad
    document.querySelectorAll('.cantidad-input').forEach(inp => {
        inp.addEventListener('focus', function () {
            if (this.value === '1') this.value = '';
        });
        inp.addEventListener('input', function () {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value === '') this.value = '1';
        });
    });
}

const searchForm = document.querySelector('form[method="get"]');
searchForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    cargarProductos({
        q: busquedaInput.value,
        per_page: perPageSelect.value,
        page: 1
    });
});

</script>
{% endblock %}