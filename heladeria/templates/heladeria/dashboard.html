{% extends 'heladeria/base_generic.html' %}
{% load static %}
{% block page_title %}Dashboard de Ventas{% endblock %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  /* Asegura que el ROW ocupe el ancho completo y no rompa el layout */
  .dashboard-row {
      margin-left: 0 !important;
      margin-right: 0 !important;
      width: 100% !important;
  }

  .dashboard-wrapper {
      max-width: 1200px;
      margin: auto;
      padding-left: 15px;
      padding-right: 15px;
      padding-top: 20px;
      width: 100%;
  }
</style>

<div class="dashboard-wrapper">

  <!-- ROW PRINCIPAL DEL DASHBOARD -->
  <div class="row h-100 gx-4 dashboard-row">

    <!-- LISTA DE PRODUCTOS -->
    <div class="col-md-8 col-lg-9 overflow-auto">

      <!-- BUSCADOR -->
      <form method="get" class="mb-3 row g-2 align-items-center">
        <div class="col-sm-6 col-md-6 col-lg-6">
          <input type="text" name="q" class="form-control" placeholder="Buscar producto..." value="{{ query }}">
        </div>

        <div class="col-auto d-flex align-items-center">
          <label for="per_page" class="me-2 fw-semibold mb-0">Mostrar:</label>
          <select name="per_page" id="per_page" class="form-select me-2" style="width:auto;" onchange="this.form.submit()">
            <option value="8" {% if per_page|stringformat:'s' == '8' %}selected{% endif %}>8</option>
            <option value="12" {% if per_page|stringformat:'s' == '12' %}selected{% endif %}>12</option>
            <option value="16" {% if per_page|stringformat:'s' == '16' %}selected{% endif %}>16</option>
          </select>
          <span class="me-2">por p√°gina</span>
        </div>

        <div class="col-auto ms-auto">
          <button type="submit" class="btn btn-outline-primary">Buscar</button>
        </div>
      </form>

      <!-- PRODUCTOS -->
      <div class="row g-4">
        {% for producto in productos %}
        <div class="col-6 col-sm-4 col-md-3">
          <div class="card shadow-sm border-0 h-100">

            {% if producto.imagen %}
              <img src="{{ producto.imagen.url }}" class="card-img-top" alt="{{ producto.nombre|escape }}" style="height:150px; object-fit:cover;">
            {% else %}
              <div class="bg-secondary d-flex align-items-center justify-content-center" style="height:150px;">
                <span class="text-white">Sin imagen</span>
              </div>
            {% endif %}

            <div class="card-body d-flex flex-column">
              <h6 class="card-title mb-1 text-truncate" title="{{ producto.nombre|escape }}">
                {{ producto.nombre }}
              </h6>

              <p class="mb-2 text-primary fw-bold">${{ producto.precio|floatformat:2 }}</p>

              <div class="d-flex justify-content-center align-items-center mb-2">
                <div class="input-group input-group-sm" style="width:120px;">
                  <button class="btn btn-outline-secondary btn-decr" type="button" data-target="#cantidad-{{ producto.id }}">‚àí</button>

                  <input id="cantidad-{{ producto.id }}"
                    type="text"
                    class="form-control text-center cantidad-input"
                    value="1"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    maxlength="2">

                  <button class="btn btn-outline-secondary btn-incr" type="button" data-target="#cantidad-{{ producto.id }}">+</button>
                </div>
              </div>

              <button
                type="button"
                class="btn btn-success btn-sm mt-auto add-btn"
                data-id="{{ producto.id }}"
                data-name="{{ producto.nombre|escape }}"
                data-price="{{ producto.precio|floatformat:2 }}">
                Agregar
              </button>
            </div>

          </div>
        </div>
        {% empty %}
          <p class="text-muted">No se encontraron productos.</p>
        {% endfor %}
      </div>

      <!-- PAGINACI√ìN -->
      {% if page_obj.has_other_pages %}
      <nav class="mt-4">
        <ul class="pagination justify-content-center">

          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?q={{ query }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">Anterior</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="?q={{ query }}&per_page={{ per_page }}&page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?q={{ query }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Siguiente</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
          {% endif %}

        </ul>
      </nav>
      {% endif %}

    </div>

    <!-- CARRITO -->
    <div class="col-md-4 col-lg-3 bg-light border-start d-flex flex-column">

      <div class="p-3 border-bottom">
        <h5 class="fw-bold">üõí Carrito</h5>
      </div>

      <div id="carrito-lista" class="flex-grow-1 overflow-auto p-3">
        <p class="text-muted">No hay productos agregados</p>
      </div>

      <div class="p-3 border-top">
        <h6 class="fw-bold">Total: $<span id="total">0.00</span></h6>

        <form id="checkout-form" method="post" action="{% url 'confirmar_venta' %}">
          {% csrf_token %}
          <input type="hidden" name="carrito_json" id="carrito_json">

          <div class="mb-2">
            <label for="cliente" class="form-label fw-semibold">Cliente</label>

            <input type="text" id="cliente-search" class="form-control mb-2" placeholder="Buscar cliente...">

            <select name="cliente" id="cliente" class="form-select" required>
              <option value="" selected disabled>Selecciona un cliente</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn btn-primary w-100 mt-2" id="finalizar-btn" disabled>
            Finalizar Compra
          </button>

        </form>

      </div>

    </div>

  </div>

</div>



<script>
  const CART_KEY = 'heladeria_carrito_v1';

  function loadCartFromStorage() {
    try {
      const raw = localStorage.getItem(CART_KEY);
      if (!raw) return {};
      return JSON.parse(raw);
    } catch (e) {
      console.error('Error parseando carrito en localStorage', e);
      return {};
    }
  }

  function saveCartToStorage(cart) {
    try {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    } catch (e) {
      console.error('Error guardando carrito en localStorage', e);
    }
  }

  const carrito = loadCartFromStorage();

  function parseNumber(v) {
    const n = parseFloat(String(v).replace(',', '.'));
    return isNaN(n) ? 0 : n;
  }
  
  function actualizarTotalYBoton() {
    let total = 0;
    for (const id in carrito) {
      total += carrito[id].precio * carrito[id].cantidad;
    }
    document.getElementById('total').textContent = total.toFixed(2);
    document.getElementById('finalizar-btn').disabled = Object.keys(carrito).length === 0;
    document.getElementById('carrito_json').value = JSON.stringify(carrito);
    saveCartToStorage(carrito);
  }

  function renderCarrito() {
    const lista = document.getElementById('carrito-lista');
    lista.innerHTML = '';
    if (Object.keys(carrito).length === 0) {
      lista.innerHTML = '<p class="text-muted">No hay productos agregados</p>';
      actualizarTotalYBoton();
      return;
    }

    for (const id in carrito) {
      const item = carrito[id];
      const subtotal = (item.precio * item.cantidad).toFixed(2);
      const row = document.createElement('div');
      row.className = 'd-flex justify-content-between align-items-center border-bottom py-2';
      row.innerHTML = `
        <div style="max-width:70%;">
          <strong class="d-block text-truncate" title="${item.nombre}">${item.nombre}</strong>
          <small>${item.cantidad} √ó $${item.precio.toFixed(2)}</small>
        </div>
        <div class="text-end">
          <div class="fw-bold">$${subtotal}</div>
          <div class="mt-1">
            <button class="btn btn-sm btn-outline-secondary btn-decrease" data-id="${id}">‚àí</button>
            <button class="btn btn-sm btn-outline-secondary btn-increase" data-id="${id}">+</button>
            <button class="btn btn-sm btn-link text-danger btn-remove" data-id="${id}">Eliminar</button>
          </div>
        </div>
      `;
      lista.appendChild(row);
    }

    lista.querySelectorAll('.btn-remove').forEach(b => b.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      delete carrito[id];
      renderCarrito();
      actualizarTotalYBoton();
    }));
    lista.querySelectorAll('.btn-decrease').forEach(b => b.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      if (carrito[id]) {
        carrito[id].cantidad = Math.max(1, carrito[id].cantidad - 1);
        renderCarrito();
        actualizarTotalYBoton();
      }
    }));
    lista.querySelectorAll('.btn-increase').forEach(b => b.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      if (carrito[id]) {
        carrito[id].cantidad = Math.min(100, carrito[id].cantidad + 1);
        renderCarrito();
        actualizarTotalYBoton();
      }
    }));

    actualizarTotalYBoton();
  }

  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const name = btn.dataset.name || 'Producto';
      const price = parseNumber(btn.dataset.price);
      const input = document.getElementById(`cantidad-${id}`);
      let cantidad = 1;
      if (input) {
        cantidad = parseInt(input.value) || 1;
        if (cantidad < 1) cantidad = 1;
      }
      if (carrito[id]) {
        carrito[id].cantidad = Math.min(100, carrito[id].cantidad + cantidad);
      } else {
        carrito[id] = { nombre: name, precio: price, cantidad: Math.min(100, cantidad) };
      }

      renderCarrito();
      actualizarTotalYBoton();
    });
  });

  document.querySelectorAll('.btn-incr, .btn-decr').forEach(b => {
    b.addEventListener('click', (e) => {
      const selector = e.currentTarget.dataset.target;
      const input = document.querySelector(selector);
      if (!input) return;
      let val = parseInt(input.value) || 1;
      if (e.currentTarget.classList.contains('btn-incr')) {
        val = Math.min(100, val + 1);
      } else {
        val = Math.max(1, val - 1);
      }
      input.value = val;

    });
  });

  document.querySelectorAll('.cantidad-input').forEach(inp => {
    inp.addEventListener('focus', function () {
      if (this.value === '1') this.value = '';
    });

    inp.addEventListener('input', function () {
      // Solo permitir n√∫meros
      this.value = this.value.replace(/[^0-9]/g, '');

      // Evitar que quede vac√≠o
      if (this.value === '') this.value = '1';
    });
  });


  renderCarrito();

  const form = document.getElementById("checkout-form");

  if (form) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);

      try {
        const response = await fetch(form.action, {
          method: "POST",
          headers: { "X-Requested-With": "XMLHttpRequest" },
          body: formData
        });

        if (!response.ok) throw new Error("Error al confirmar la compra");

        Swal.fire({
          icon: "success",
          title: "¬°Compra confirmada!",
          text: "Tu compra ha sido registrada correctamente.",
          confirmButtonText: "Aceptar",
          timer: 2000,
          showConfirmButton: false
        });

        for (const id in carrito) delete carrito[id];
        renderCarrito();
        actualizarTotalYBoton();
        localStorage.removeItem(CART_KEY);

      } catch (error) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "No se pudo confirmar la compra. Int√©ntalo nuevamente.",
        });
      }
    });
  }

  /* üîç FILTRO EN VIVO DE CLIENTES ---------------------------- */
  const clienteSearch = document.getElementById("cliente-search");
  const clienteSelect = document.getElementById("cliente");

  if (clienteSearch && clienteSelect) {
    clienteSearch.addEventListener("input", function () {
      const filtro = this.value.toLowerCase();

      for (const option of clienteSelect.options) {
        const texto = option.textContent.toLowerCase();

        if (option.value === "") {
          option.hidden = false;
          continue;
        }

        option.hidden = !texto.includes(filtro);
      }
    });
  }
  /* ---------------------------------------------------------- */

</script>


{% endblock %}
