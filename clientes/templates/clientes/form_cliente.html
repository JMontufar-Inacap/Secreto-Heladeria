{% extends 'heladeria/base_generic.html' %}
{% load static %}
{% load icons %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'clientes/css/cliente_form.css' %}">
{% endblock %}

{% block page_title %}
    {{ accion }} cliente
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <form method="post" novalidate>
        {% csrf_token %}

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card soft-card">
                    <div class="card-body">
                        <h5 class="card-title ms-2-5">Informaci贸n del Cliente</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nombre</label>
                                <div class="input-group">
                                    <span class="input-group-text">{% icon "person_icon" %}</span>
                                    {{ form.nombre }}
                                </div>
                                {% for error in form.nombre.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Apellido</label>
                                <div class="input-group">
                                    <span class="input-group-text">{% icon "person_icon" %}</span>
                                    {{ form.apellido }}
                                </div>
                                {% for error in form.apellido.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">RUT</label>
                                <div class="input-group">
                                    <span class="input-group-text">{% icon "id_icon" %}</span>
                                    {{ form.rut }}
                                </div>
                                {% for error in form.rut.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tel茅fono</label>
                                <div class="input-group">
                                    <span class="input-group-text">{% icon "phone_icon" %}</span>
                                    {{ form.telefono }}
                                </div>
                                {% for error in form.telefono.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <div class="input-group">
                                    <span class="input-group-text">{% icon "mail_icon" %}</span>
                                    {{ form.email }}
                                </div>
                                {% for error in form.email.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Direcci贸n</label>
                                <div class="input-group">
                                    <span class="input-group-text">{% icon "map_icon" %}</span>
                                    {{ form.direccion }}
                                </div>
                                {% for error in form.direccion.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Pa铆s</label>
                                <div class="input-group">
                                    <span class="input-group-text"></span>
                                    <input type="text" class="form-control" value="Chile" disabled>
                                </div>
                                <input type="hidden" name="pais" value="Chile">
                            </div>

                            <div class="col-md-4 mb-2">
                                <label class="form-label">Regi贸n</label>
                                {{ form.region }}
                                {% for error in form.region.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="col-md-4 mb-2">
                                <label class="form-label">Comuna</label>
                                {{ form.comuna }}
                                {% for error in form.comuna.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 d-flex flex-column">
                <div class="card soft-card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Configuraci贸n</h5>
                        <div class="mb-3">
                            <label class="form-label">Tipo de cliente</label>
                            {{ form.tipo_cliente }}
                            {% for error in form.tipo_cliente.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Idioma preferido</label>
                            {{ form.idioma_preferido }}
                            {% for error in form.idioma_preferido.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Documento por defecto</label>
                            {{ form.documento_preferido }}
                            {% for error in form.documento_preferido.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <hr>

                        <div class="form-check mb-2">
                            {{ form.enviar_comprobante_email }}
                            <label class="form-check-label">Enviar comprobante por email</label>
                        </div>
                        <div class="form-check">
                            {{ form.recibe_promociones }}
                            <label class="form-check-label">Recibir promociones</label>
                        </div>
                    </div>
                </div>

                <div class="mt-auto d-flex justify-content-end gap-2 pt-3">
                    <a href="{% url 'lista_clientes' %}" class="btn-action btn-secondary-action px-4">Cancelar</a>
                    <button type="submit" class="btn-action btn-primary-action px-5">{{ accion }}</button>
                </div>
            </div>
        </div>
    </form>
</div>

{% if mensaje %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    Swal.fire({
        title: "{{ mensaje }}",
        icon: "{{ tipo_mensaje }}",
        confirmButtonText: "OK",
        timer: 2500,
        timerProgressBar: true,
    }).then(() => {
        {% if tipo_mensaje == 'success' %}
            window.location.href = "{% url 'lista_clientes' %}";
        {% endif %}
    });
});
</script>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {
    const CHILE_DATA = {{ regiones_comunas_json|safe }};
    const regionSelect = document.getElementById("region_select");
    const comunaSelect = document.getElementById("comuna_select");
    const selectedComuna = "{{ form.comuna.value|default:''|escapejs }}";

    function updateComunas() {
        const selectedRegion = regionSelect.value;
        comunaSelect.innerHTML = '<option value="">Seleccione comuna</option>';
        const region = CHILE_DATA.find(r => r.region === selectedRegion);
        if(region) {
            region.comunas.forEach(comuna => {
                const option = document.createElement("option");
                option.value = comuna;
                option.textContent = comuna;
                if(comuna === selectedComuna) option.selected = true;
                comunaSelect.appendChild(option);
            });
        }
    }

    regionSelect.addEventListener("change", () => {
        updateComunas();
        comunaSelect.value = "";
    });
    updateComunas();
});

document.addEventListener("DOMContentLoaded", () => {
    const nombreInput = document.getElementById("id_nombre");
    const apellidoInput = document.getElementById("id_apellido");
    const rutInput = document.getElementById("id_rut");
    const telefonoInput = document.getElementById("id_telefono");

    function soloLetras(event) {
        const regex = /[A-Za-z谩茅铆贸煤帽\s]/;
        if (!regex.test(event.key)) {
            event.preventDefault();
        }
    }

    function soloRut(event) {
        const key = event.key.toUpperCase();
        const value = rutInput.value.toUpperCase();

        if (/[0-9]/.test(key)) return;
        if (key === "-" && !value.includes("-")) return;
        if ((key === "K") && value.indexOf("-") !== -1 && value.indexOf("K") === -1 && value.length === value.indexOf("-")+1) return;

        event.preventDefault();
    }

    function soloNumeros(event) {
        const regex = /[0-9]/;
        if (!regex.test(event.key)) {
            event.preventDefault();
        }
    }

    nombreInput.addEventListener("keypress", soloLetras);
    apellidoInput.addEventListener("keypress", soloLetras);
    rutInput.addEventListener("keypress", soloRut);
    telefonoInput.addEventListener("keypress", soloNumeros);
});
</script>
{% endblock %}
