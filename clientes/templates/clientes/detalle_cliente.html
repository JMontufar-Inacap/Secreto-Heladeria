{% extends 'heladeria/base_generic.html' %}
{% load static %}
{% load formatos %}
{% block page_title %}Cliente - {{ cliente.nombre_completo}}{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'clientes/css/lista_clientes.css' %}">{% endblock %}

{% block content %}

<div class="container py-4">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="card shadow-sm mb-4">
        <div class="card-body">

            <div class="d-flex justify-content-between align-items-start flex-wrap">

                <!-- IZQUIERDA: Nombre + ubicación -->
                <div>
                    <h2 class="fw-bold mb-2">{{ cliente.nombre_completo}}</h2>

                    <p class="text-muted mb-1">
                        <i class="bi bi-geo-alt-fill me-1"></i>
                        {{ cliente.direccion|default:"Dirección no registrada" }}
                    </p>
                </div>

                <div style="text-align: left;">
                    <p class="mb-1">
                        <i class="bi bi-person-badge-fill me-1"></i>
                        <strong>RUT:</strong> {{ cliente.rut |formato_rut}}
                    </p>
                    <p class="mb-1">
                        <i class="bi bi-telephone-fill me-1"></i>
                        <strong>Teléfono:</strong> {{ cliente.telefono|formato_telefono|default:"-" }}
                    </p>

                    <p class="mb-0">
                        <i class="bi bi-envelope-fill me-1"></i>
                        <strong>Email:</strong> {{ cliente.email|default:"-" }}
                    </p>
                </div>

            </div>

        </div>
    </div>

    <!-- CARD COMBINADO: Estadísticas + Lista de ventas -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">

            <!-- ESTADÍSTICAS -->
            <div class="d-flex justify-content-between text-center mb-4">

                <!-- Total pedidos -->
                <div class="flex-fill border-end pe-3">
                    <h1 class="fw-bold">{{ total_pedidos }}</h1>
                    <p class="text-muted mb-0">Total de pedidos realizados</p>
                </div>

                <!-- Total gastado -->
                <div class="flex-fill ps-3">
                    <h1 class="fw-bold">${{ total_compras |precio_cl}}</h1>
                    <p class="text-muted mb-0">Total gastado por el cliente</p>
                </div>

            </div>

            <!-- TÍTULO LISTA -->
            <hr class="my-4">
            <!-- TABLA (contenedor AJAX) -->
            <div id="tablaContainer"></div>


        </div>
    </div>
    
    {% include 'clientes/graficos_cliente.html' %}

    <a href="{% url 'lista_clientes' %}" class="btn btn-outline-primary">← Volver</a>

</div>

<!-- Gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const ctx = document.getElementById('graficoCompras');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: [{% for v in ventas %}"{{ v.fecha|date:'d/m' }}",{% endfor %}],
            datasets: [{
                label: "Total $",
                data: [{% for v in ventas %}{{ v.total }},{% endfor %}],
                borderWidth: 2,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

document.addEventListener("DOMContentLoaded", function () {
    cargarTablaDetalleCliente();
});

function cargarTablaDetalleCliente(params = "") {
    const baseUrl = "{% url 'detalle_cliente_ajax' cliente.id %}";
    const currentParams = new URLSearchParams(window.currentTableParams || "");

    if (params) {
        const newParams = new URLSearchParams(params);
        newParams.forEach((v, k) => currentParams.set(k, v));
    }

    window.currentTableParams = currentParams.toString();

    fetch(baseUrl + "?" + window.currentTableParams)
        .then(r => r.json())
        .then(data => {
            document.getElementById("tablaContainer").innerHTML = data.html;
        });
}

// PAGINACIÓN
document.addEventListener("click", function (e) {
    if (e.target.classList.contains("pagination-btn") && e.target.dataset.page) {
        cargarTablaDetalleCliente("page=" + e.target.dataset.page);
    }
});

// PAGE SIZE
document.addEventListener("change", function (e) {
    if (e.target.name === "page_size") {
        cargarTablaDetalleCliente("page_size=" + e.target.value);
    }
});

document.addEventListener("click", function (e) {
    const link = e.target.closest("a");
    if (!link) return;

    if (link.classList.contains("no-ajax")) {
        // dejar que el navegador descargue el archivo
        return;
    }
});

/* ==========================
   FILTROS (SweetAlert)
========================== */
document.addEventListener("click", function (e) {
    const btn = e.target.closest("#btnFiltros");
    if (!btn) return;

    Swal.fire({
        title: "Filtros",
        html: document.getElementById("modal-filtros").innerHTML,
        width: 480,
        padding: "1.5rem",
        background: "white",
        showCancelButton: true,
        confirmButtonText: "Aplicar filtros",
        cancelButtonText: "Cancelar",

        didOpen: () => {
            const swalBox = Swal.getHtmlContainer();
            const params = new URLSearchParams(window.currentTableParams || "");

            swalBox.querySelector("#f_estado").value =
                params.get("estado") || "";

            swalBox.querySelector("#f_min_precio").value =
                params.get("min_precio") || "";

            swalBox.querySelector("#f_max_precio").value =
                params.get("max_precio") || "";
        },

        preConfirm: () => {
            const swalBox = Swal.getHtmlContainer();
            const params = new URLSearchParams(window.currentTableParams || "");

            const estado = swalBox.querySelector("#f_estado").value;
            const minPrecio = swalBox.querySelector("#f_min_precio").value;
            const maxPrecio = swalBox.querySelector("#f_max_precio").value;

            if (estado) params.set("estado", estado);
            else params.delete("estado");

            if (minPrecio) params.set("min_precio", minPrecio);
            else params.delete("min_precio");

            if (maxPrecio) params.set("max_precio", maxPrecio);
            else params.delete("max_precio");

            cargarTablaDetalleCliente(params.toString());
        }
    });
});
</script>

{% endblock %}
